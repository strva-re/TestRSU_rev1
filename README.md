# TestRSU_rev1.cde

Я не углублялся слишком сильно в решение проблемы. Думал, как можно сделать проще и быстрее. Самое банальное – это отреверсить систему уже имеющихся логов.
![1](https://github.com/user-attachments/assets/f9cd2ebb-c6c8-4805-bee2-4d16ba03dcda)

## Шаги, которые я предпринял:

1. **Запуск отладчика и изучение**:
   - Запустил отладчик и начал изучать приложение.
   - Обнаружил, что приложение использует MFC (это для меня экзотика, но я уже работал с подобными приложениями раньше).

2. **Дампа MFC**:
   - Сделал дамп `mfc90u` (для удобства).
   - Открыл дамп параллельно в дизассемблере.

3. **Бряков на WinAPI функции, связанные с печатью**:
   - Установил пару бряков на WinAPI функции, связанные с печатью: `OpenPrinterW` и `StartDocW`.
   - Проанализировал стек вызовов, чтобы понять, откуда происходит вызов.

4. **Поиск тринера**:
   - Обнаружил, что вызовы происходят из функции `CView::OnFilePrint(CView *this)`.
   - Нашел это место в дампе `mfc90u` и начал анализировать его.

5. **Поиск тринера 2**:
   - Обнаружил, что логика функции не выполнится, если не будет выполнено условие `*(_WORD *)(CWnd::GetCurrentMessage() + 8) != 0xE108`.
    ![ida_sc](https://github.com/user-attachments/assets/eaf4f519-e473-4f64-a527-63de57f537c7)
   - Нашел, откуда и как устанавливается триггер, воспроизвел его.
    ![ida_sc_2](https://github.com/user-attachments/assets/8ddfc542-f26a-4b66-98a1-fa91f590dc15)

## Моя идея:

Перенаправить печать с принтера на встроенный Microsoft Print to PDF, который сохраняет все прямо в файл. Для этого нужно хукнуть функцию `StartDocW` и добавить туда путь к файлу `lpdi->lpszOutput`.
![hook](https://github.com/user-attachments/assets/c233b331-1644-401b-8fb4-fffe0f1acb9e)

## Ну и сам процесс:

inject hook -> find interface windows -> send triggers -> done

## ToDo:
   - На проде я бы по другому искал окна.
   - Можно сделать свой виртуальный принтер.
   - Ну и пару патчей в исполняемый бинарник, для стабильности выбора принтера.
