# TestRSU_rev1.cde

Я не углублялся слишком сильно в бинарник. 

Самое банальное – это отреверсить систему уже имеющихся логов.
![1](https://github.com/user-attachments/assets/6f70eb95-099c-4225-8825-f00947913767)

## Шаги, которые я предпринял:

1. **Запуск отладчика и изучение**:
   - Запустил отладчик и начал изучать приложение.
   - Обнаружил, что приложение использует MFC (это для меня экзотика, но я уже работал с подобными приложениями раньше).

2. **Дампа MFC**:
   - Сделал дамп `mfc90u` (для удобства).
   - Открыл дамп параллельно в дизассемблере.

3. **Бряков на WinAPI функции, связанные с печатью**:
   - Установил пару бряков на WinAPI функции, связанные с печатью: `OpenPrinterW` и `StartDocW`.
   - Проанализировал стек вызовов, чтобы понять, откуда происходит вызов.

4. **Поиск триггера**:
   - Обнаружил, что вызовы происходят из функции `CView::OnFilePrint(CView *this)`.
   - Нашел это место в дампе `mfc90u` и начал анализировать его.

5. **Поиск триггера 2**:
   - Обнаружил, что логика функции не выполнится, если не будет выполнено условие `*(_WORD *)(CWnd::GetCurrentMessage() + 8) != 0xE108`.
   ![ida_sc](https://github.com/user-attachments/assets/dc3f13ea-b1aa-48cb-b430-6fb271a81354)

   - Нашел, откуда и как устанавливается триггер, воспроизвел его.
   ![ida_sc_2](https://github.com/user-attachments/assets/624fe068-6ef3-4009-b747-30f20a0dc410)

## Моя идея:

Перенаправить печать с принтера на встроенный Microsoft Print to PDF, который сохраняет все прямо в файл. Для этого нужно хукнуть функцию `StartDocW` и добавить туда путь к файлу `lpdi->lpszOutput`.
![hook](https://github.com/user-attachments/assets/9c223e38-f7ab-4d21-ad8a-3f16225e97d9)

## Ну и сам процесс:

inject hook -> find interface windows -> send triggers -> done

## ToDo:
   - На проде я бы по другому искал окна.
   - Можно сделать свой виртуальный принтер.
   - Ну и пару патчей в исполняемый бинарник, для стабильности выбора принтера.
